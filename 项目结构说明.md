# ScutChat 项目结构说明文档

## 项目概述

ScutChat 是一个基于 PHP 的轻量级实时聊天室应用，采用文件存储方式保存聊天记录，支持多用户同时在线聊天。

## 目录结构

```
scutchat/
├── index.php              # 主入口页面（聊天室界面）
├── index.html             # 音乐播放页面（独立页面）
├── 404.html               # 404错误页面
└── app/                   # 应用核心目录
    ├── app.php            # 核心功能库文件（常量定义、工具函数）
    ├── ajax.php           # AJAX请求处理文件（登录、发送消息、获取消息）
    ├── MSG.txt            # 聊天消息存储文件（自动生成）
    ├── NUM.txt            # 数字统计文件（预留）
    └── style/             # 前端资源目录
        ├── chat.css       # 聊天界面样式文件
        ├── chat.min.js    # 聊天功能JavaScript文件（压缩版）
        ├── jquery.min.js  # jQuery库文件
        └── bg.jpg         # 背景图片资源
```

## 文件功能说明

### 1. 入口文件

#### `index.php`
- **功能**：聊天室主页面
- **主要特性**：
  - 引入 `app/app.php` 核心库
  - 检查用户Cookie，判断是否已登录
  - 未登录用户显示昵称输入框和"进入"按钮
  - 已登录用户显示聊天消息区域和消息输入框
  - 集成网易云音乐播放器
  - 引入前端样式和脚本文件

#### `index.html`
- **功能**：独立的音乐播放页面
- **主要特性**：
  - 显示歌词内容
  - 内置音乐播放器
  - 支持播放列表和自动连播功能

#### `404.html`
- **功能**：404错误页面
- **说明**：标准的nginx 404错误提示页面

### 2. 核心功能文件

#### `app/app.php`
- **功能**：核心功能库文件
- **包含内容**：
  - 常量定义（路径、文件、密钥等）
  - 会话管理初始化
  - 用户昵称生成函数
  - 消息日志记录函数
  - Token验证函数
  - 通用工具函数

#### `app/ajax.php`
- **功能**：处理所有AJAX请求
- **支持的请求类型**：
  - `c=login`：用户登录/注册
  - `c=send`：发送聊天消息
  - `c=msg`：获取聊天消息列表
- **安全机制**：
  - Token验证防止CSRF攻击
  - 消息内容过滤（strip_tags）
  - 管理员权限验证

### 3. 前端资源文件

#### `app/style/chat.css`
- **功能**：聊天界面样式定义
- **包含**：聊天框、消息气泡、输入框、按钮等样式

#### `app/style/chat.min.js`
- **功能**：聊天功能JavaScript实现
- **主要功能**：
  - 消息发送处理
  - 消息接收和轮询
  - 界面更新和滚动
  - 用户登录处理
  - 消息显示和格式化

#### `app/style/jquery.min.js`
- **功能**：jQuery库文件
- **说明**：前端JavaScript框架依赖

### 4. 数据存储文件

#### `app/MSG.txt`
- **功能**：聊天消息存储文件
- **格式**：每行一条JSON格式的消息记录
- **生成方式**：自动创建，通过 `file_put_contents` 追加写入

#### `app/NUM.txt`
- **功能**：数字统计文件（预留）
- **说明**：当前代码中已定义但未使用

## 技术架构

### 后端技术
- **语言**：PHP
- **会话管理**：Session + Cookie
- **数据存储**：文件系统（文本文件）
- **安全机制**：Token验证、内容过滤

### 前端技术
- **框架**：jQuery
- **样式**：原生CSS
- **交互**：AJAX异步请求
- **轮询机制**：定时器轮询获取新消息

## 工作流程

### 用户登录流程
1. 用户访问 `index.php`
2. 检查Cookie中是否存在用户信息
3. 如果不存在，显示昵称输入框
4. 用户输入昵称，点击"进入"按钮
5. 发送AJAX请求到 `ajax.php?c=login`
6. 服务器生成或使用已有昵称，创建唯一key
7. 将用户信息存入Cookie
8. 返回用户信息，前端完成登录

### 消息发送流程
1. 用户在输入框输入消息
2. 点击"发送"按钮
3. 前端验证消息长度和发送频率
4. 发送AJAX POST请求到 `ajax.php?c=send`
5. 服务器验证Token和消息内容
6. 将消息追加写入 `MSG.txt` 文件
7. 返回消息JSON，前端立即显示

### 消息接收流程
1. 页面加载后启动定时器
2. 每秒发送AJAX请求到 `ajax.php?c=msg&k=消息索引`
3. 服务器读取 `MSG.txt` 文件
4. 比较消息数量，返回新消息列表
5. 前端解析JSON，更新聊天界面
6. 自动滚动到底部显示最新消息

## 安全特性

1. **Token验证**：防止CSRF攻击
2. **内容过滤**：使用 `strip_tags` 过滤HTML标签
3. **长度限制**：消息最大140字符，昵称最大5字符
4. **发送频率限制**：3秒内只能发送一条消息
5. **管理员功能**：支持管理员清空聊天记录（发送"clear"消息）

## 配置说明

### 常量配置（app.php中定义）
- `BASE_PATH`：应用基础路径
- `ROOT_PATH`：项目根路径
- `MSGFILE`：消息文件路径
- `NUMFILE`：统计文件路径
- `KEYS`：Cookie密钥前缀
- `LSTR`：管理员登录密钥

### 时区设置
- 默认时区：`PRC`（中国时区）

## 依赖要求

- PHP 5.4+
- Web服务器（Apache/Nginx）
- 文件写入权限（app目录需要可写）

## 注意事项

1. **文件权限**：确保 `app` 目录有写入权限，用于创建和更新 `MSG.txt` 文件
2. **并发处理**：使用 `LOCK_EX` 文件锁防止并发写入冲突
3. **性能考虑**：消息文件会持续增长，建议定期清理或实现消息归档
4. **安全性**：生产环境建议加强安全验证，考虑使用数据库存储

## 扩展建议

1. 使用数据库替代文件存储，提高性能和可维护性
2. 实现WebSocket实时通信，替代轮询机制
3. 添加用户认证系统
4. 实现消息分页和归档功能
5. 添加图片、文件上传功能
6. 实现私聊功能
7. 添加消息撤回功能

