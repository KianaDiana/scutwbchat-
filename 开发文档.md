# ScutChat 开发文档

## 目录

1. [开发环境搭建](#开发环境搭建)
2. [项目配置](#项目配置)
3. [代码结构说明](#代码结构说明)
4. [开发规范](#开发规范)
5. [功能开发指南](#功能开发指南)
6. [常见问题与解决方案](#常见问题与解决方案)
7. [调试技巧](#调试技巧)
8. [部署指南](#部署指南)

---

## 开发环境搭建

### 系统要求

- **PHP版本**：PHP 5.4 或更高版本
- **Web服务器**：Apache 2.x 或 Nginx 1.x
- **操作系统**：Windows、Linux、macOS
- **浏览器**：Chrome、Firefox、Edge、Safari（现代浏览器）

### 本地开发环境搭建

#### 方案一：使用 XAMPP（推荐Windows/Mac用户）

1. **下载安装 XAMPP**
   - 访问：https://www.apachefriends.org/
   - 下载对应系统版本
   - 安装到默认目录（如：`C:\xampp`）

2. **配置项目**
   ```bash
   # 将项目复制到 XAMPP 的 htdocs 目录
   C:\xampp\htdocs\scutchat\
   ```

3. **启动服务**
   - 打开 XAMPP Control Panel
   - 启动 Apache 服务
   - 访问：`http://localhost/scutchat/`

#### 方案二：使用 PHP 内置服务器（快速测试）

1. **进入项目目录**
   ```bash
   cd D:\360MoveData\Users\向\Desktop\scutchat
   ```

2. **启动服务器**
   ```bash
   php -S localhost:8000
   ```

3. **访问项目**
   - 浏览器打开：`http://localhost:8000/`

#### 方案三：使用 Docker（推荐）

1. **创建 Dockerfile**
   ```dockerfile
   FROM php:7.4-apache
   COPY . /var/www/html/
   RUN chmod -R 777 /var/www/html/app
   EXPOSE 80
   ```

2. **构建和运行**
   ```bash
   docker build -t scutchat .
   docker run -d -p 8080:80 scutchat
   ```

### 目录权限设置

确保 `app` 目录有写入权限：

**Linux/macOS:**
```bash
chmod -R 755 app/
chmod 666 app/MSG.txt  # 如果文件已存在
```

**Windows:**
- 右键 `app` 文件夹 → 属性 → 安全
- 给 `Users` 组添加"修改"权限

### 开发工具推荐

- **代码编辑器**：VS Code、PhpStorm、Sublime Text
- **调试工具**：Xdebug、浏览器开发者工具
- **API测试**：Postman、curl
- **版本控制**：Git

---

## 项目配置

### 基础配置

配置文件位置：`app/app.php`

#### 修改 Cookie 密钥

```php
define('KEYS','bskdl87');  // 修改为自定义密钥
```

#### 修改管理员密钥

```php
define('LSTR','admin');  // 修改管理员登录密钥
```

#### 修改消息存储路径

```php
define('MSGFILE','app/MSG.txt');  // 可以修改为其他路径
```

### 开发环境配置

#### 开启错误显示（开发时）

在 `app/app.php` 开头修改：

```php
<?php
// 开发环境：显示所有错误
error_reporting(E_ALL);
ini_set('display_errors', 1);

// 生产环境：关闭错误显示
// error_reporting(0);
session_start();
// ...
```

### 前端配置

#### 修改轮询间隔

编辑 `app/style/chat.min.js`（建议使用未压缩版本）：

```javascript
// 默认1秒轮询
c = setInterval(function(){
    get_msg()
}, 1000);  // 修改这里的数值（毫秒）

// 长时间无响应后改为10秒轮询
}, 10000);  // 修改这里的数值
```

#### 修改发送频率限制

```javascript
// 3秒限制
setTimeout(function(){
    $("#send").removeClass("disabled")
}, 3000);  // 修改这里的数值（毫秒）
```

---

## 代码结构说明

### 文件组织

```
scutchat/
├── index.php           # 主入口（视图层）
├── index.html          # 音乐页面（独立页面）
├── app/
│   ├── app.php        # 核心库（模型层）
│   ├── ajax.php       # 接口处理（控制器层）
│   └── style/         # 前端资源
└── 404.html           # 错误页面
```

### MVC 架构说明

虽然项目不是严格的MVC，但可以理解为：

- **Model（模型层）**：`app/app.php` - 业务逻辑和数据操作
- **View（视图层）**：`index.php` - 用户界面
- **Controller（控制器层）**：`app/ajax.php` - 请求处理

### 数据流向

```
用户操作 → index.php (前端JS)
    ↓
AJAX请求 → ajax.php (路由分发)
    ↓
调用函数 → app.php (业务逻辑)
    ↓
文件操作 → MSG.txt (数据存储)
    ↓
返回JSON → 前端更新界面
```

---

## 开发规范

### 代码风格

#### PHP 代码规范

1. **缩进**：使用4个空格（不使用Tab）
2. **命名**：
   - 函数名：小写+下划线，如 `get_token()`
   - 变量名：小写+下划线，如 `$user_name`
   - 常量名：大写+下划线，如 `MSGFILE`
3. **注释**：
   ```php
   /**
    * 函数功能说明
    * @param string $user 用户昵称
    * @return array 用户信息数组
    */
   function nick($user='') {
       // 具体实现
   }
   ```

#### JavaScript 代码规范

1. **变量命名**：驼峰命名，如 `currentSongIndex`
2. **函数命名**：驼峰命名，如 `getMessage()`
3. **常量命名**：全大写下划线，如 `MAX_MESSAGE_LENGTH`

### 安全规范

#### 1. 输入验证

```php
// ✅ 正确：使用 strip_tags 过滤HTML
$msg = strip_tags($_POST['msg']);

// ✅ 正确：使用 mb_substr 限制长度
$msg = mb_substr($msg, 0, 140, 'utf-8');

// ❌ 错误：直接使用用户输入
$msg = $_POST['msg'];
```

#### 2. SQL注入防护（如使用数据库）

```php
// ✅ 使用预处理语句
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$id]);

// ❌ 错误：字符串拼接
$sql = "SELECT * FROM users WHERE id = " . $id;
```

#### 3. XSS防护

```php
// ✅ 输出时转义
echo htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');

// ✅ 使用 strip_tags 过滤
$clean = strip_tags($user_input);
```

#### 4. CSRF防护

```php
// ✅ 使用Token验证
if(check_post($arr) == false){
    exit('Token验证失败');
}
```

### 文件操作规范

#### 使用文件锁

```php
// ✅ 正确：使用 LOCK_EX 防止并发写入
file_put_contents($file, $content, FILE_APPEND | LOCK_EX);

// ❌ 错误：不使用锁
file_put_contents($file, $content, FILE_APPEND);
```

#### 错误处理

```php
// ✅ 添加错误检查
$result = file_put_contents($file, $content, LOCK_EX);
if($result === false) {
    error_log("写入文件失败: " . $file);
    // 处理错误
}
```

### Git 提交规范

```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

示例：
```
feat: 添加用户头像功能
fix: 修复Token验证bug
docs: 更新开发文档
```

---

## 功能开发指南

### 添加新功能模块

#### 步骤1：在后端添加处理逻辑

在 `app/ajax.php` 中添加新的case：

```php
case 'newfeature':
    // 处理逻辑
    $result = process_new_feature($_POST);
    echo json_encode($result);
    break;
```

#### 步骤2：在 app.php 中添加辅助函数

```php
function process_new_feature($data) {
    // 验证数据
    // 处理业务逻辑
    // 返回结果
    return array('success' => true, 'data' => $result);
}
```

#### 步骤3：在前端添加调用

```javascript
function callNewFeature() {
    $.post("app/ajax.php?c=newfeature", {
        data: value
    }, function(response) {
        // 处理响应
        if(response.success) {
            // 更新界面
        }
    }, "json");
}
```

### 修改消息存储方式（使用数据库）

#### 1. 创建数据库表

```sql
CREATE TABLE messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    msg TEXT NOT NULL,
    type VARCHAR(10) DEFAULT 'msg',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created (created_at)
);
```

#### 2. 修改 app.php 添加数据库连接

```php
function get_db() {
    static $pdo = null;
    if($pdo === null) {
        $pdo = new PDO(
            'mysql:host=localhost;dbname=scutchat',
            'username',
            'password'
        );
    }
    return $pdo;
}
```

#### 3. 修改消息写入函数

```php
function save_message($name, $msg, $type = 'msg') {
    $pdo = get_db();
    $stmt = $pdo->prepare(
        "INSERT INTO messages (name, msg, type) VALUES (?, ?, ?)"
    );
    $stmt->execute([$name, $msg, $type]);
    return $pdo->lastInsertId();
}
```

#### 4. 修改消息读取函数

```php
function get_messages($offset = 0, $limit = 50) {
    $pdo = get_db();
    $stmt = $pdo->prepare(
        "SELECT * FROM messages ORDER BY id DESC LIMIT ? OFFSET ?"
    );
    $stmt->execute([$limit, $offset]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}
```

### 添加用户认证功能

#### 1. 创建用户表

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. 添加登录验证函数

```php
function verify_user($username, $password) {
    $pdo = get_db();
    $stmt = $pdo->prepare(
        "SELECT * FROM users WHERE username = ?"
    );
    $stmt->execute([$username]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if($user && password_verify($password, $user['password'])) {
        return $user;
    }
    return false;
}
```

### 实现WebSocket实时通信（替代轮询）

#### 1. 安装Ratchet库

```bash
composer require cboden/ratchet
```

#### 2. 创建WebSocket服务器

```php
// websocket_server.php
use Ratchet\MessageComponentInterface;
use Ratchet\ConnectionInterface;

class Chat implements MessageComponentInterface {
    protected $clients;
    
    public function __construct() {
        $this->clients = new \SplObjectStorage;
    }
    
    public function onOpen(ConnectionInterface $conn) {
        $this->clients->attach($conn);
    }
    
    public function onMessage(ConnectionInterface $from, $msg) {
        foreach ($this->clients as $client) {
            $client->send($msg);
        }
    }
    
    public function onClose(ConnectionInterface $conn) {
        $this->clients->detach($conn);
    }
    
    public function onError(ConnectionInterface $conn, \Exception $e) {
        $conn->close();
    }
}

$server = Ratchet\App('localhost', 8080);
$server->route('/chat', new Chat, array('*'));
$server->run();
```

#### 3. 前端连接WebSocket

```javascript
const ws = new WebSocket('ws://localhost:8080/chat');

ws.onmessage = function(event) {
    const msg = JSON.parse(event.data);
    addmsg(msg.name, msg.msg, 'left');
};

function sendMessage(msg) {
    ws.send(JSON.stringify({
        name: name,
        msg: msg
    }));
}
```

---

## 常见问题与解决方案

### 问题1：消息文件无法写入

**症状**：消息发送后没有保存

**原因**：目录权限不足

**解决方案**：
```bash
# Linux/macOS
chmod 755 app/
chmod 666 app/MSG.txt

# Windows: 右键文件夹 → 属性 → 安全 → 添加写入权限
```

### 问题2：Cookie无法设置

**症状**：用户每次刷新都需要重新登录

**原因**：
- `session_start()` 必须在任何输出之前调用
- Cookie路径设置不正确

**解决方案**：
```php
// 确保在文件开头调用
<?php
session_start();
// 确保没有输出（包括空格、BOM等）

// Cookie路径设置为根路径
setcookie(KEYS.'_name', $name, time()+3600*24*30, '/');
```

### 问题3：Token验证总是失败

**症状**：`check_post()` 总是返回false

**原因**：代码中使用了未定义的 `KEY` 常量

**解决方案**：
```php
// 将 app.php 中的 KEY 替换为 KEYS
// 错误：
$_SESSION[KEY.'token']

// 正确：
$_SESSION[KEYS.'token']
```

### 问题4：中文乱码

**症状**：昵称或消息显示为乱码

**原因**：字符编码不一致

**解决方案**：
```php
// 1. 确保PHP文件使用UTF-8编码保存
// 2. 在HTML头部设置编码
<meta charset="utf-8">

// 3. 使用mb_*函数处理中文
mb_substr($str, 0, 140, 'utf-8');
```

### 问题5：消息文件过大导致性能问题

**症状**：页面加载变慢，读取消息超时

**解决方案**：

1. **实现消息归档**
```php
function archive_messages() {
    $max_lines = 10000;
    $lines = file(ROOT_PATH.MSGFILE);
    if(count($lines) > $max_lines) {
        $old = array_slice($lines, 0, -5000);
        $new = array_slice($lines, -5000);
        
        // 保存旧消息到归档文件
        file_put_contents(
            ROOT_PATH.'app/MSG_'.date('Ymd').'.txt',
            implode('', $old)
        );
        
        // 保留最新5000条
        file_put_contents(
            ROOT_PATH.MSGFILE,
            implode('', $new)
        );
    }
}
```

2. **使用数据库**（推荐长期方案）

### 问题6：并发写入冲突

**症状**：多条消息丢失

**解决方案**：确保使用文件锁
```php
file_put_contents($file, $content, FILE_APPEND | LOCK_EX);
```

---

## 调试技巧

### PHP调试

#### 1. 开启错误显示

```php
error_reporting(E_ALL);
ini_set('display_errors', 1);
ini_set('log_errors', 1);
ini_set('error_log', 'php_error.log');
```

#### 2. 使用var_dump调试

```php
// 调试变量
var_dump($variable);
exit; // 立即停止执行查看输出
```

#### 3. 使用error_log记录

```php
error_log("调试信息: " . print_r($data, true));
```

#### 4. 使用Xdebug（推荐）

安装Xdebug扩展，在PhpStorm中配置断点调试。

### JavaScript调试

#### 1. 使用console.log

```javascript
console.log('变量值:', variable);
console.error('错误信息:', error);
```

#### 2. 使用浏览器开发者工具

- F12 打开开发者工具
- Console标签查看日志
- Network标签查看AJAX请求
- Sources标签设置断点

#### 3. 查看AJAX请求

```javascript
$.ajax({
    url: 'app/ajax.php',
    success: function(data) {
        console.log('成功:', data);
    },
    error: function(xhr, status, error) {
        console.error('错误:', error);
        console.log('响应:', xhr.responseText);
    }
});
```

### 文件操作调试

```php
// 检查文件是否存在
if(!file_exists(ROOT_PATH.MSGFILE)) {
    error_log("消息文件不存在: " . ROOT_PATH.MSGFILE);
}

// 检查文件权限
if(!is_writable(ROOT_PATH.MSGFILE)) {
    error_log("消息文件不可写: " . ROOT_PATH.MSGFILE);
}

// 检查文件内容
$content = file_get_contents(ROOT_PATH.MSGFILE);
error_log("文件内容: " . substr($content, 0, 200));
```

---

## 部署指南

### 生产环境配置

#### 1. 关闭错误显示

```php
error_reporting(0);
ini_set('display_errors', 0);
```

#### 2. 修改安全密钥

```php
// 使用随机生成的密钥
define('KEYS', 'your_random_secret_key_here');
define('LSTR', 'your_admin_secret_key_here');
```

#### 3. 设置目录权限

```bash
# 只给app目录写入权限
chmod 755 app/
chmod 644 app/MSG.txt  # 如果文件已存在，设置为644
```

#### 4. 配置Web服务器

**Apache配置（.htaccess）**

```apache
# 启用重写引擎
RewriteEngine On

# 防止直接访问敏感文件
<Files "*.txt">
    Order Allow,Deny
    Deny from all
</Files>

# PHP配置
php_value upload_max_filesize 10M
php_value post_max_size 10M
```

**Nginx配置**

```nginx
server {
    listen 80;
    server_name yourdomain.com;
    root /var/www/scutchat;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # 禁止访问txt文件
    location ~ \.txt$ {
        deny all;
    }
}
```

### 备份策略

#### 1. 定期备份消息文件

```bash
# 创建备份脚本 backup.sh
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
cp app/MSG.txt backups/MSG_$DATE.txt
# 保留最近30天的备份
find backups/ -name "MSG_*.txt" -mtime +30 -delete
```

#### 2. 设置定时任务

```bash
# 添加到crontab
0 2 * * * /path/to/backup.sh
```

### 性能优化建议

1. **使用OPcache**：缓存PHP字节码
2. **启用Gzip压缩**：减少传输数据量
3. **使用CDN**：加速静态资源加载
4. **数据库优化**：如使用数据库，添加适当的索引
5. **定期清理**：定期归档或清理旧消息

### 监控建议

1. **日志监控**：监控PHP错误日志和访问日志
2. **文件大小监控**：监控MSG.txt文件大小
3. **性能监控**：使用工具监控服务器资源使用
4. **错误报警**：设置错误邮件通知

---

## 附录

### 参考资源

- PHP官方文档：https://www.php.net/docs.php
- jQuery文档：https://api.jquery.com/
- PSR编码规范：https://www.php-fig.org/psr/

### 相关文档

- [项目结构说明.md](./项目结构说明.md)
- [app.php说明文档.md](./app.php说明文档.md)
- [测试手册.md](./测试手册.md)

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：开发团队

